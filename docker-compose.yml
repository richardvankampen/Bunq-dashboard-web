version: '3.8'

services:
  bunq-dashboard:
    build:
      context: .
    
    container_name: bunq-dashboard
    restart: unless-stopped
    
    ports:
      # Single port for both API and Frontend (simplified architecture)
      # Access: http://your-nas-ip:5000 (via VPN only!)
      - "${DASHBOARD_PORT:-5000}:5000"
    
    environment:
      # ============================================
      # VAULTWARDEN CONFIGURATION (RECOMMENDED)
      # ============================================
      VAULTWARDEN_URL: "${VAULTWARDEN_URL:-http://vaultwarden:80}"
      VAULTWARDEN_CLIENT_ID: "${VAULTWARDEN_CLIENT_ID}"
      VAULTWARDEN_CLIENT_SECRET: "${VAULTWARDEN_CLIENT_SECRET}"
      VAULTWARDEN_ITEM_NAME: "${VAULTWARDEN_ITEM_NAME:-Bunq API Key}"
      USE_VAULTWARDEN: "${USE_VAULTWARDEN:-true}"
      
      # ============================================
      # SESSION-BASED AUTHENTICATION
      # ============================================
      BASIC_AUTH_USERNAME: "${BASIC_AUTH_USERNAME:-admin}"
      BASIC_AUTH_PASSWORD: "${BASIC_AUTH_PASSWORD}"
      FLASK_SECRET_KEY: "${FLASK_SECRET_KEY}"
      SESSION_COOKIE_SECURE: "${SESSION_COOKIE_SECURE:-false}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-http://localhost:5000}"
      
      # ============================================
      # BUNQ CONFIGURATION
      # ============================================
      BUNQ_ENVIRONMENT: "${BUNQ_ENVIRONMENT:-PRODUCTION}"
      
      # Alternative: Direct API Key (NOT RECOMMENDED)
      # Only use if NOT using Vaultwarden
      # BUNQ_API_KEY: "${BUNQ_API_KEY}"
      
      # ============================================
      # APPLICATION SETTINGS
      # ============================================
      FLASK_DEBUG: "${FLASK_DEBUG:-false}"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"

      # Performance / Cache
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
      CACHE_TTL_SECONDS: "${CACHE_TTL_SECONDS:-60}"
      DEFAULT_PAGE_SIZE: "${DEFAULT_PAGE_SIZE:-500}"
      MAX_PAGE_SIZE: "${MAX_PAGE_SIZE:-2000}"
      MAX_DAYS: "${MAX_DAYS:-3650}"
    
    volumes:
      # Persistent storage for Bunq context and logs
      - bunq-config:/app/config
      - bunq-logs:/app/logs
    
    depends_on:
      - vaultwarden
    
    networks:
      - bunq-network
    
    # Resource limits (adjust based on your NAS)
    deploy:
      resources:
        limits:
          cpus: '1.0'
          memory: 1024M
        reservations:
          cpus: '0.5'
          memory: 512M
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
  
  vaultwarden:
    image: vaultwarden/server:latest
    container_name: vaultwarden
    restart: unless-stopped
    
    ports:
      # Vaultwarden web interface
      # Access: http://your-nas-ip:8080
      - "${VAULTWARDEN_PORT:-8080}:80"
    
    volumes:
      # Persistent storage for Vaultwarden vault data
      - vaultwarden-data:/data
    
    environment:
      # Domain for Vaultwarden (update with your NAS IP or domain)
      DOMAIN: "${VAULTWARDEN_DOMAIN:-http://localhost:8080}"
      
      # CRITICAL: Set to 'false' AFTER creating your first account!
      SIGNUPS_ALLOWED: "${VAULTWARDEN_SIGNUPS:-false}"
      
      # WebSocket support (for browser extension sync)
      WEBSOCKET_ENABLED: "true"
      
      # Logging
      LOG_LEVEL: "info"
      
      # Optional: Admin token (generate with: openssl rand -base64 48)
      # ADMIN_TOKEN: "${VAULTWARDEN_ADMIN_TOKEN}"
    
    networks:
      - bunq-network
    
    # Resource limits
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:80/alive"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

# Named volumes for data persistence
volumes:
  bunq-config:
    driver: local
    # Optional: bind to specific path on host
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /volume1/docker/bunq-dashboard/config
  
  bunq-logs:
    driver: local
    # Optional: bind to specific path on host
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /volume1/docker/bunq-dashboard/logs
  
  vaultwarden-data:
    driver: local
    # Optional: bind to specific path on host
    # driver_opts:
    #   type: none
    #   o: bind
    #   device: /volume1/docker/vaultwarden

# Network configuration
networks:
  bunq-network:
    driver: bridge
    # Optional: specify subnet
    # ipam:
    #   config:
    #     - subnet: 172.28.0.0/16

# ============================================
# USAGE EXAMPLES
# ============================================
#
# Build:
#   docker-compose build
#   docker-compose up -d
#
# View logs:
#   docker-compose logs -f bunq-dashboard
#   docker-compose logs -f vaultwarden
#
# Restart services:
#   docker-compose restart
#
# Stop services:
#   docker-compose down
#
# Rebuild without cache:
#   docker-compose build --no-cache
#   docker-compose up -d
#
# ============================================
