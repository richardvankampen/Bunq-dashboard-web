version: '3.8'

services:
  bunq-dashboard:
    image: bunq-dashboard:local

    ports:
      # Single port for both API and Frontend (simplified architecture)
      # Access: http://your-nas-ip:5000 (via VPN only!)
      - "5000:5000"

    environment:
      # Non-secret configuration (from .env or defaults)
      BASIC_AUTH_USERNAME: "${BASIC_AUTH_USERNAME:-admin}"
      VAULTWARDEN_URL: "${VAULTWARDEN_URL:-http://vaultwarden:80}"
      VAULTWARDEN_ACCESS_METHOD: "${VAULTWARDEN_ACCESS_METHOD:-cli}"
      VAULTWARDEN_ITEM_NAME: "${VAULTWARDEN_ITEM_NAME:-Bunq API Key}"
      USE_VAULTWARDEN: "${USE_VAULTWARDEN:-true}"
      BUNQ_ENVIRONMENT: "${BUNQ_ENVIRONMENT:-PRODUCTION}"
      AUTO_SET_BUNQ_WHITELIST_IP: "${AUTO_SET_BUNQ_WHITELIST_IP:-true}"
      AUTO_SET_BUNQ_WHITELIST_DEACTIVATE_OTHERS: "${AUTO_SET_BUNQ_WHITELIST_DEACTIVATE_OTHERS:-false}"
      ALLOWED_ORIGINS: "${ALLOWED_ORIGINS:-https://bunq.jouwdomein.nl}"
      SESSION_COOKIE_SECURE: "${SESSION_COOKIE_SECURE:-true}"
      FLASK_DEBUG: "${FLASK_DEBUG:-false}"
      LOG_LEVEL: "${LOG_LEVEL:-INFO}"
      CACHE_ENABLED: "${CACHE_ENABLED:-true}"
      CACHE_TTL_SECONDS: "${CACHE_TTL_SECONDS:-60}"
      DEFAULT_PAGE_SIZE: "${DEFAULT_PAGE_SIZE:-500}"
      MAX_PAGE_SIZE: "${MAX_PAGE_SIZE:-2000}"
      MAX_DAYS: "${MAX_DAYS:-3650}"
      DATA_DB_ENABLED: "${DATA_DB_ENABLED:-true}"
      DATA_DB_PATH: "${DATA_DB_PATH:-config/dashboard_data.db}"
      FX_ENABLED: "${FX_ENABLED:-true}"
      FX_RATE_SOURCE: "${FX_RATE_SOURCE:-frankfurter}"
      FX_REQUEST_TIMEOUT_SECONDS: "${FX_REQUEST_TIMEOUT_SECONDS:-8}"
      FX_CACHE_HOURS: "${FX_CACHE_HOURS:-24}"

    secrets:
      - source: bunq_basic_auth_password
        target: basic_auth_password
      - source: bunq_flask_secret_key
        target: flask_secret_key
      - source: bunq_vaultwarden_client_id
        target: vaultwarden_client_id
      - source: bunq_vaultwarden_client_secret
        target: vaultwarden_client_secret
      - source: bunq_vaultwarden_master_password
        target: vaultwarden_master_password
      # Optional: only when USE_VAULTWARDEN=false
      # - source: bunq_api_key
      #   target: bunq_api_key

    volumes:
      # Persistent storage for Bunq context and logs (Synology bind mounts)
      - /volume1/docker/bunq-dashboard/config:/app/config
      - /volume1/docker/bunq-dashboard/logs:/app/logs

    networks:
      - bunq-net

    deploy:
      restart_policy:
        condition: any
        delay: 5s
        max_attempts: 0
        window: 60s

    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:5000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

# Network configuration
networks:
  bunq-net:
    external: true

# ============================================
# USAGE EXAMPLES
# ============================================
#
# Build image:
#   docker build -t bunq-dashboard:local .
#
# Deploy (Swarm):
#   docker stack deploy -c docker-compose.yml bunq
#
# View logs:
#   docker service logs -f bunq_bunq-dashboard
#
# Restart service:
#   docker service update --force bunq_bunq-dashboard
#
# Stop stack:
#   docker stack rm bunq
#
# ============================================
# Swarm secrets (must be created before deploy)
secrets:
  bunq_basic_auth_password:
    external: true
  bunq_flask_secret_key:
    external: true
  bunq_vaultwarden_client_id:
    external: true
  bunq_vaultwarden_client_secret:
    external: true
  bunq_vaultwarden_master_password:
    external: true
  # Optional: only when USE_VAULTWARDEN=false
  # bunq_api_key:
  #   external: true
